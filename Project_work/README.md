# Автоматизация бэкапирования ClickHouse

## Описание проекта

Этот проект автоматизирует процесс создания резервных копий (бэкапов) баз данных ClickHouse. Скрипт позволяет:
- Анализировать таблицы в базе данных и их размеры (на основе прав пользователя под которым подключились).
- Выбирать таблицы для бэкапа.
- Выполнять бэкап последовательно или параллельно.
- Архивировать бэкапы или оставлять их в виде отдельных файлов.
- Логировать все действия в файл для последующего анализа.

Проект также включает настройку ClickHouse через `docker-compose.yml`, который автоматически создает три базы данных (`test_db`, `example_db2`, `example_db3`) с тестовыми данными.

```tex
60% заявленного функционала - когда предоставленный тестовый пример отработал так, как описано в текущей инструкции.
80% когда этот скрипт можно прогнать по сторонней базе до которой будет доступ
100% всё работает, ещё и по https
```
___
```
Идеей проекта послужил сценарий, при котором к сотруднику обращаются коллеги с просьбой - сохранить данные из "клика" и сложить куда-нибудь, "а вдруг пригодится".
Возникло желание создать простой и понятный инструмент, который позволит дать всем желающим возможность "спасти себя самостоятельно" (⊙.⊙(☉̃ₒ☉)⊙.⊙)
либо упростить себе жизнь, в случае если коллеги-таки принудительно поделились этим заданием ( ◡́.◡̀)(^◡^ ).
```
---

## Changelog

### Версия 1.0
- Добавлена базовая функциональность для бэкапа одной базы данных.
- Реализован выбор таблиц для бэкапа.
- Добавлено логирование действий в файл.

### Версия 1.1
- Добавлена возможность параллельного бэкапа таблиц.
- Добавлен выбор архивации бэкапов (да/нет).
- Улучшена легенда завершения работы скрипта.

### Версия 1.2
- Добавлены дополнительные SQL-скрипты для создания двух новых баз данных (`example_db2`, `example_db3`).
- Обновлен `docker-compose.yml` для автоматического выполнения всех SQL-скриптов при запуске контейнера.

## Версия 1.3
- **Новая логика выбора баз данных и таблиц**:
  - Теперь при запуске скрипта выводится список всех доступных баз данных и их таблиц.
  - Пользователь может выбрать конкретные базы данных и таблицы для бэкапа или использовать ключевое слово `all` для выбора всех доступных объектов.
- **Улучшенная структура данных**:
  - Добавлен ассоциативный массив `DATABASE_TABLES` для хранения информации о базах данных и их таблицах.
- **Параллельный бэкап с поддержкой нескольких баз данных**:
  - Параллельный бэкап теперь работает для таблиц из нескольких баз данных.
- **Оптимизация взаимодействия с пользователем**:
  - Улучшено взаимодействие с пользователем за счет пошагового выбора баз данных и таблиц.

## Версия 1.4 (beta version)
- **Поддержка HTTPS**:
  - Добавлена возможность работы с ClickHouse через HTTPS.
  - Все запросы к ClickHouse теперь выполняются через `https://`.
- **Работа с самоподписанными сертификатами**:
  - Добавлена опция для игнорирования проверки SSL-сертификатов (`--insecure`).
  - Поддержка доверенных сертификатов через параметр `--cacert`.
- **Изменение порта по умолчанию**:
  - Порт по умолчанию изменён на `8443` (типичный порт для HTTPS в ClickHouse).
- **Параметры для curl**:
  - Добавлены параметры `--insecure` и `--cacert` для работы с SSL/TLS.

## Версия 1.5
 **UI**
- Возможность использовать значения по умолчанию для хоста (localhost), порта (8123) и пользователя (default) + пустой пароль.
- Подсказки о значениях по умолчанию при вводе данных.
- Улучшена читаемость интерфейса за счет разделения длинных сообщений на строки.
- Исправлена проблема с пустым выводом при использовании функции log_message.
- Устранены конфликты между echo и log_message.
- Эксперимент с раскраской логов "like an airbyte script"

## Версия 2
 **Добавлен альтернативный скрипт v2**
- поменян вывод в лог файл
- добавлен вывод дата+время на каждую функцию
- добавлены дефолтные значения в вводимые параметры
- убран параллелизм (часто вешал скрипт, уходит в TBD)
- добавлены валидации вводимых значений
- пофикшено отображение строк и размера таблиц
- пофикшены огрехи с форматированием и раскраской
---

## Шаги развертывания и настройки компонентов

### 1. Подготовка окружения
Убедитесь, что у вас установлены следующие компоненты:
- Docker и Docker Compose.
- Bash (для выполнения скрипта).
- Curl (обращение к KH)

### 2. Клонирование репозитория
Склонируйте репозиторий с проектом:
```bash
git clone https://github.com/rayenv/klickhouse_learning.git
cd klickhouse_learning/Project_work/
```

### 3. Запуск ClickHouse
Запустите ClickHouse с помощью [docker-compose.yml](docker-compose.yml). Это создаст три базы данных с тестовыми данными:
```bash
docker-compose up -d
```

### 4. Проверка баз данных
Проверьте, что базы данных созданы:
```bash
curl -sS --user "default:password" "http://localhost:8123/?query=SHOW+DATABASES"
```

### 5. Настройка скрипта бэкапа
Сделайте скрипт исполняемым:
```bash
chmod +x backup_v2.sh
```

### 6. Запуск скрипта бэкапа
Запустите скрипт:
```bash
./backup_v2.sh
```

Скрипт запросит у вас данные для подключения к ClickHouse, путь для сохранения бэкапов и запрос архивации.

---
### Ожидаемый пример работы скрипта:

Шаг 1: Запуск скрипта
```bash
./backup_v2.sh
```
Шаг 2: Ввод данных
```bash
2025-02-09 05:26:59 ***********************************************
2025-02-09 05:26:59 * Настройка подключения к ClickHouse
2025-02-09 05:26:59 ***********************************************
2025-02-09 05:26:59 Введите хост ClickHouse (например, localhost) [по умолчанию: localhost]:
2025-02-09 05:27:00 Введите порт ClickHouse (например, 8123) [по умолчанию: 8123]:
2025-02-09 05:27:00 Введите имя пользователя ClickHouse (по умолчанию: default):
2025-02-09 05:27:00 Введите пароль пользователя ClickHouse (оставьте пустым, если пароль не требуется):
2025-02-09 05:27:03 ***********************************************
2025-02-09 05:27:03 * Выбор директории для сохранения бэкапа
2025-02-09 05:27:03 ***********************************************
2025-02-09 05:27:03 Введите путь к директории для сохранения бэкапа [по умолчанию: /home/user/klickhouse_learning/Project_work]:
Бэкапы будут сохраняться в директории: /home/user/klickhouse_learning/Project_work
2025-02-09 05:27:06 Использовать самоподписанный сертификат? (yes/no): no
2025-02-09 05:27:08 ***********************************************
2025-02-09 05:27:08 * Проверка подключения к ClickHouse
2025-02-09 05:27:08 ***********************************************
Подключение к ClickHouse успешно установлено.
2025-02-09 05:27:08 ***********************************************
2025-02-09 05:27:08 * Анализ доступных баз данных
2025-02-09 05:27:08 ***********************************************
2025-02-09 05:27:08 Список доступных баз данных:
2025-02-09 05:27:08   - INFORMATION_SCHEMA
2025-02-09 05:27:08   - default
2025-02-09 05:27:08   - example_db2
2025-02-09 05:27:08   - example_db3
2025-02-09 05:27:08   - information_schema
2025-02-09 05:27:08   - system
2025-02-09 05:27:08   - test_db
2025-02-09 05:27:08 Введите названия баз данных для бэкапа через пробел:
2025-02-09 05:27:08 - или 'all' для бекапа всех пользовательских таблиц
test_db example_db2
Список таблиц в выбранных базах данных:
2025-02-09 05:27:17 База данных: example_db2
2025-02-09 05:27:17 Таблицы:
2025-02-09 05:27:17   - cars (строк: 3, размер: 0 MB)
2025-02-09 05:27:17 База данных: test_db
2025-02-09 05:27:17 Таблицы:
2025-02-09 05:27:17   - guitars (строк: 3, размер: 0 MB)
2025-02-09 05:27:17 Выберите таблицы для бэкапа в базе 'test_db':
2025-02-09 05:27:17 - или 'all' для бекапа всех таблиц
2025-02-09 05:27:17 - или '-' для отказа от бекапа таблиц этой базы:
all
2025-02-09 05:27:19 Выберите таблицы для бэкапа в базе 'example_db2':
2025-02-09 05:27:19 - или 'all' для бекапа всех таблиц
2025-02-09 05:27:19 - или '-' для отказа от бекапа таблиц этой базы:
guitars
2025-02-09 05:27:20 Хотите архивировать бэкапы?
2025-02-09 05:27:20 - Введите 'yes' для создания архива
2025-02-09 05:27:20 - Введите 'no' для сохранения файлов без архивации:
yes
2025-02-09 05:27:22 ***********************************************
2025-02-09 05:27:22 * Выполняется бэкап выбранных таблиц...
2025-02-09 05:27:22 ***********************************************
2025-02-09 05:27:22 Выполняется бэкап таблицы 'cars' из базы 'example_db2'...
2025-02-09 05:27:23 Бэкап таблицы 'cars' из базы 'example_db2' успешно завершен.
2025-02-09 05:27:23 Выполняется бэкап таблицы 'guitars' из базы 'test_db'...
2025-02-09 05:27:23 Бэкап таблицы 'guitars' из базы 'test_db' успешно завершен.
Архивация бэкапов в файл: /home/user/klickhouse_learning/Project_work/backup-20250209052722.tar.gz
Архив успешно создан: /home/user/klickhouse_learning/Project_work/backup-20250209052722.tar.gz
```

Шаг 3: Результат
```bash
2025-02-09 05:27:23 ***********************************************
2025-02-09 05:27:23 * Отчёт о работе скрипта
2025-02-09 05:27:23 ***********************************************
Результаты работы скрипта:
Успешно забэкапировано таблиц: 2
Архив бэкапа: /home/user/klickhouse_learning/Project_work/backup-20250209052722.tar.gz
Файл логов: /home/user/klickhouse_learning/Project_work/backup_clickhouse.log
Время выполнения скрипта: 24 секунд
2025-02-09 05:27:23 ***********************************************
2025-02-09 05:27:23 * Завершение работы скрипта
2025-02-09 05:27:23 ***********************************************
```
---

## Подход к организации мониторинга и логирования

### Логирование
- Все действия скрипта записываются в файл `backup_clickhouse.log`.
- Лог содержит метки времени, описание действий и результаты выполнения.

Пример содержимого лога:
```plaintext
2023-10-10 12:00:00 - Директория /backups не существует. Создаю...
2023-10-10 12:00:01 - Список таблиц и их размеры:
2023-10-10 12:00:01 - users: 1.2KB
2023-10-10 12:00:01 - logs: 5.6MB
2023-10-10 12:00:02 - Бэкап выполняется параллельно...
2023-10-10 12:00:05 - Архивация бэкапов в файл: /backups/test_db-backup-20231010120000.tar.gz
2023-10-10 12:00:06 - Архив успешно создан: /backups/test_db-backup-20231010120000.tar.gz
```

### Мониторинг
- Время выполнения скрипта выводится в легенде завершения работы.
- Ошибки при бэкапе конкретных таблиц фиксируются в логах и выводятся в легенде.

---

## Дополнительная информация про решение

### Особенности реализации
1. **Анализ таблиц**:
   - Скрипт анализирует таблицы в базе данных и их размеры, используя системную таблицу `system.tables`.
   - Пользователь может выбрать конкретные таблицы или использовать ключевое слово `all`.

2. **Параллельный бэкап**:
   - Для параллельного бэкапа используется команда `xargs` с параметром `-P` для указания количества параллельных процессов.

3. **Архивация**:
   - Если выбрана архивация, все файлы бэкапа упаковываются в один `.tar.gz` файл.
   - Если архивация не выбрана, файлы остаются в указанной директории.

4. **Легенда завершения**:
   - В конце работы скрипта выводится подробная информация о результатах, включая количество успешно забэкапированных таблиц, ошибки, путь к архиву или файлам, время выполнения и путь к логам.

### Возможные улучшения
1. **Очистка старых бэкапов**:
   - Добавить функцию для удаления бэкапов старше определенного количества дней.

2. **Интеграция с мониторингом**:
   - Добавить отправку уведомлений о завершении бэкапа (например, через email или Slack).

3. **Поддержка других форматов бэкапа**:
   - Добавить возможность экспорта данных в другие форматы (например, CSV или JSON).

4. **Допилить работу c https://**:
   - Пока проскакивают ошибки, надо поотслеживать, поразмышлять на досуге.

5. **Параллелизм**:
   - Доработать возможность параллельного бекапирования массы таблиц.
---
